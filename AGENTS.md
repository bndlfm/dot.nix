# Agent Guide for NixOS Configuration

This repository contains NixOS and Home Manager configurations using Flakes.

## ‚ö° Quick Start

### Core Commands

- **Apply System Configuration**:
  ```bash
  nh os switch .
  # OR
  sudo nixos-rebuild switch --flake .
  ```

- **Apply Home Configuration**:
  ```bash
  nh home switch .
  # OR
  home-manager switch --flake .
  ```

- **Update Dependencies**:
  ```bash
  nix flake update
  ```

- **Format Code**:
  ```bash
  nix fmt
  ```

### Hosts & Users

- **Hosts**:
  - `meow` (Desktop, x86_64-linux)
  - `nyaa` (Server, x86_64-linux)
  - `paperless-container`
- **User**: `neko`

## üìÇ Project Structure

- **`flake.nix`**: Entry point. Defines inputs, outputs, and overlays.
- **`blocks/`**: Reusable modules.
  - `*.sys.nix`: NixOS system modules.
  - `*.home.nix`: Home Manager modules.
- ** containers **: Containers ( in Nix lang - use `compose2nix` to convert docker compose yaml to nix ]
  - `*.sys.nix`: NixOS system level containers.
  - `*.home.nix`: Home Manager level containers (usermode).
- **`hosts/`**: System-level configurations (NixOS).
  - `hosts/<hostname>/default.nix`: Main system config.
  - `hosts/<hostname>/hardware.nix`: Hardware specific config.
- **`home/`**: User-level configurations (Home Manager).
  - `home/<user>/default.nix`: Main home config.
- **`programs/`**: Application-specific configurations.
- **`pkgs/`**: Custom packages and overlays.
- **`sops/`**: Secrets managed by `sops-nix`.
- **`theme/`**: Stylix theming configurations.

## üß© Key Patterns & Conventions

### Module Naming
- Use `.sys.nix` suffix for NixOS system modules (e.g., `modules/wm/hyprland.sys.nix`).
- Use `.home.nix` suffix for Home Manager modules (e.g., `modules/wm/hyprland.home.nix`).

### Package Management
- **Custom Packages**: Defined in `pkgs/` and exposed via overlays in `flake.nix`.
- **Unstable Packages**: Default `nixpkgs` input is `nixos-unstable`.
- **Stable Packages**: Available via `pkgs.stable` (if overlay configured) or separate input.

### Secrets
- Managed via `sops-nix`.
- Secrets are defined in `sops/secrets.sys.yaml` and `sops/secrets.home.yaml`.
- Keys are in `sops/*.yaml`.
- **DO NOT** commit unencrypted secrets or `.env` files.

### Theming
- Uses `stylix` for system-wide theming.
- Configuration in `theme/nxStylix.nix` (NixOS) and `theme/hmStylix.nix` (Home Manager).

## ‚ö†Ô∏è Gotchas

- **Nix Helper (`nh`)**: The system uses `nh` for switching configurations. Use it preferentially over raw `nixos-rebuild`.
- **Flake Inputs**: Many programs (Hyprland, Niri, Zen Browser) are pinned via flake inputs. Check `flake.nix` for versions.
- **Read-Only Stores**: Configuration files generated by Nix are read-only. Edit the `.nix` source files, not the resulting config files in `/etc` or `~/.config`.
- **Impurity**: `nixos-rebuild` generally requires root. `home-manager` does not.

## üß™ Testing

- **Syntax Check**: `nix instanciate --parse flake.nix` (basic syntax).
- **Build without Switch**:
  ```bash
  # Build system
  nix build .#nixosConfigurations.meow.config.system.build.toplevel

  # Build home
  nix build .#homeConfigurations."neko@meow".activationPackage
  ```
